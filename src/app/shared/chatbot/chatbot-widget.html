<!-- Floating button -->
<div class="fixed bottom-5 right-5 z-[9999]">
  <button
    (click)="toggle()"
    class="w-14 h-14 rounded-full shadow-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition"
    [attr.title]="isOpen() ? ('CHATBOT.TOOLTIP_CLOSE' | translate) : ('CHATBOT.TOOLTIP_OPEN' | translate)"
    type="button"
  >
    <i class="ph" [class.ph-x]="isOpen()" [class.ph-chat-teardrop-text]="!isOpen()" class="text-2xl"></i>
  </button>
</div>

<!-- Panel -->
@if (isOpen()) {
  <div class="fixed bottom-24 right-5 z-[9999] w-[420px] max-w-[calc(100vw-2.5rem)] h-[620px] max-h-[calc(100vh-8rem)] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col">
    <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
          <i class="ph ph-headset text-blue-600 dark:text-blue-300"></i>
        </div>
        <div>
          <div class="text-sm font-semibold text-slate-800 dark:text-white">{{ 'CHATBOT.HEADER.TITLE' | translate }}</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">{{ 'CHATBOT.HEADER.SUBTITLE' | translate }}</div>
        </div>
      </div>

      <button
        (click)="close()"
        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
        type="button"
      >
        <i class="ph ph-x text-slate-600 dark:text-slate-300"></i>
      </button>
    </div>

    <div class="flex-1 overflow-auto p-4 space-y-3">
      @for (m of messages(); track m.id) {
        @if (m.role === 'user') {
          <div class="flex justify-end">
            <div class="max-w-[85%] rounded-2xl px-4 py-3 bg-blue-600 text-white text-sm whitespace-pre-wrap">
              {{ m.content }}
            </div>
          </div>
        } @else {
          <div class="flex justify-start">
            <div class="max-w-[85%] rounded-2xl px-4 py-3 bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-100 text-sm whitespace-pre-wrap">
              {{ m.content }}

              @if (m.sources?.length) {
                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                  <div class="text-xs font-semibold text-slate-600 dark:text-slate-300 mb-2">{{ 'CHATBOT.SOURCES.TITLE' | translate }}</div>
                  <div class="space-y-2">
                    @for (s of m.sources!; track s.docUrl + ':' + s.chunkIndex) {
                      <button
                        (click)="openSource(s.docUrl)"
                        class="w-full text-left px-3 py-2 rounded-lg bg-white/70 dark:bg-slate-800/60 border border-slate-200 dark:border-slate-600 hover:bg-white dark:hover:bg-slate-800 transition"
                        type="button"
                      >
                        <div class="text-xs font-medium text-slate-700 dark:text-slate-200">
                          {{ s.docName }}#{{ s.chunkIndex }}
                        </div>
                        <div class="text-[11px] text-slate-500 dark:text-slate-400 line-clamp-3">
                          {{ s.excerpt }}
                        </div>
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      }

      @if (isWorking()) {
        <div class="flex justify-start">
          <div class="max-w-[85%] rounded-2xl px-4 py-3 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm">
            <i class="ph ph-circle-notch animate-spin mr-2"></i>
            {{ 'CHATBOT.STATUS.THINKING' | translate }}
          </div>
        </div>
      }
    </div>

    @if (suggestions().length) {
      <div class="px-3 pb-2">
        <div class="text-[11px] text-slate-500 dark:text-slate-400 mb-2">
          {{ 'CHATBOT.SUGGESTIONS.TITLE' | translate }}
        </div>
        <div class="flex flex-wrap gap-2">
          @for (s of suggestions(); track s.id) {
            <button
              type="button"
              (click)="onSuggestionClick(s)"
              class="px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-xs hover:bg-slate-50 dark:hover:bg-slate-700 transition"
            >
              {{ s.labelKey | translate }}
            </button>
          }
        </div>
      </div>
    }

    <div class="p-3 border-t border-slate-200 dark:border-slate-700">
      <div class="flex items-end gap-2">
        <textarea
          [ngModel]="input()"
          (ngModelChange)="input.set($event)"
          (keydown)="onKeyDown($event)"
          rows="2"
          class="flex-1 resize-none px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm"
          [placeholder]="'CHATBOT.INPUT.PLACEHOLDER' | translate"
        ></textarea>

        <button
          (click)="send()"
          [disabled]="isWorking()"
          class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          type="button"
        >
          <i class="ph ph-paper-plane-right"></i>
        </button>
      </div>

      <div class="mt-2 text-[11px] text-slate-500 dark:text-slate-400">
        {{ 'CHATBOT.FOOTER.HINT' | translate }}
      </div>
    </div>
  </div>
}
