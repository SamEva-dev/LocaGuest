<div class="p-6">
  <!-- üìä Statistics Cards -->
  @if (stats()) {
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Total Pay√©</p>
            <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
              {{ formatCurrency(stats()!.totalPaid) }}
            </p>
          </div>
          <i class="ph ph-check-circle text-3xl text-emerald-600 dark:text-emerald-400"></i>
        </div>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Restant D√ª</p>
            <p class="text-2xl font-bold text-slate-900 dark:text-white">
              {{ formatCurrency(stats()!.totalRemaining) }}
            </p>
          </div>
          <i class="ph ph-clock text-3xl text-slate-400"></i>
        </div>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Paiements √† Jour</p>
            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">
              {{ stats()!.countPaid }} / {{ stats()!.countPaid + stats()!.countPending + stats()!.countLate }}
            </p>
          </div>
          <i class="ph ph-calendar-check text-3xl text-blue-600 dark:text-blue-400"></i>
        </div>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">En Retard</p>
            <p class="text-2xl font-bold text-red-600 dark:text-red-400">
              {{ stats()!.countLate }}
            </p>
          </div>
          <i class="ph ph-warning text-3xl text-red-600 dark:text-red-400"></i>
        </div>
      </div>
    </div>
  }

  <!-- üîß Toolbar -->
  <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4 p-4">
      <div class="flex items-center gap-3">
        <!-- Year Filter -->
        <select 
          [(ngModel)]="filterYear" 
          (change)="loadStats()"
          class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white">
          <option [value]="0">Toutes les ann√©es</option>
          @for (year of availableYears(); track year) {
            <option [value]="year">{{ year }}</option>
          }
        </select>

        <!-- Status Filter -->
        <select 
          [(ngModel)]="filterStatus"
          class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white">
          <option value="all">Tous les statuts</option>
          <option value="Paid">Pay√©</option>
          <option value="Pending">En attente</option>
          <option value="Late">En retard</option>
          <option value="Partial">Partiel</option>
        </select>
      </div>

      <button 
        (click)="openAddPaymentModal()"
        class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
        <i class="ph ph-plus-circle"></i>
        Ajouter un paiement
      </button>
    </div>
  </div>

  <!-- üìã Payments Table -->
  <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
    @if (isLoading()) {
      <div class="flex items-center justify-center p-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    } @else if (filteredPayments().length === 0) {
      <div class="text-center p-12">
        <i class="ph ph-wallet text-5xl text-slate-300 dark:text-slate-600 mb-3"></i>
        <p class="text-slate-500 dark:text-slate-400">Aucun paiement trouv√©</p>
      </div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                P√©riode
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                Montant D√ª
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                Montant Pay√©
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                Date Paiement
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                M√©thode
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                Statut
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
            @for (payment of filteredPayments(); track payment.id) {
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex flex-col">
                    <span class="text-sm font-medium text-slate-900 dark:text-white">
                      {{ getMonthName(payment.month) }} {{ payment.year }}
                    </span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">
                      √âch√©ance: {{ formatDate(payment.expectedDate) }}
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">
                  {{ formatCurrency(payment.amountDue) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex flex-col">
                    <span class="text-sm font-semibold text-emerald-600 dark:text-emerald-400">
                      {{ formatCurrency(payment.amountPaid) }}
                    </span>
                    @if (payment.remainingAmount > 0) {
                      <span class="text-xs text-orange-600 dark:text-orange-400">
                        Reste: {{ formatCurrency(payment.remainingAmount) }}
                      </span>
                    }
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">
                  {{ formatDate(payment.paymentDate) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">
                  {{ getMethodLabel(payment.paymentMethod) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span [class]="'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + getStatusBadgeClass(payment.status)">
                    {{ getStatusLabel(payment.status) }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                  <div class="flex items-center justify-end gap-2">
                    @if (payment.receiptId) {
                      <button
                        (click)="downloadReceipt(payment)"
                        class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                        title="T√©l√©charger la quittance">
                        <i class="ph ph-download"></i>
                      </button>
                    }
                    @if (payment.note) {
                      <button
                        class="p-2 text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
                        [title]="payment.note">
                        <i class="ph ph-note"></i>
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Add Payment Modal -->
@if (showAddModal()) {
  <add-payment-modal
    [tenantId]="tenantId()"
    [tenantName]="tenantName()"
    (paymentCreated)="handlePaymentCreated()"
    (close)="handleModalClose()"
  />
}
