<div class="p-6 space-y-6">
  @if (isLoading()) {
    <div class="flex items-center justify-center py-12">
      <i class="ph ph-spinner text-4xl animate-spin text-slate-400"></i>
    </div>
  } @else if (tenant()) {
    <!-- Header Two Columns -->
    <div class="grid lg:grid-cols-2 gap-6">
      <!-- Left: Tenant Info Card -->
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-400 to-rose-500 flex items-center justify-center text-white text-3xl font-bold">
              {{ getInitials(tenant()!.fullName) }}
            </div>
            <div>
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <h3 class="text-xl font-bold">{{ tenant()!.fullName }}</h3>
                <span class="text-sm px-2 py-1 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 font-mono">{{ tenant()!.code }}</span>

                @if (hasSignedAddendums()) {
                  <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-sm font-medium border border-purple-200 dark:border-purple-800">
                    <i class="ph ph-file-plus text-base"></i>
                    <span>Avenant</span>
                  </span>
                }
              
              <!-- ‚úÖ NOUVEAU: Badge association bien -->
              @if (associatedProperty()) {
                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 text-sm font-medium border border-teal-200 dark:border-teal-800">
                  <i class="ph ph-link text-base"></i>
                  <span>Associ√© √†</span>
                  <span class="font-bold">{{ associatedProperty()!.code }}</span>
                </span>
              }
              </div>
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ tenant()!.email }}</p>
              @if (tenant()!.phone) {
                <p class="text-sm text-slate-500 dark:text-slate-400">{{ tenant()!.phone }}</p>
              }
            </div>
          </div>

          <button
            (click)="printTenantSheet()"
            [disabled]="isPrintingSheet()"
            class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-800 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            title="Imprimer la fiche"
          >
            <i class="ph" [class.ph-printer]="!isPrintingSheet()" [class.ph-circle-notch]="isPrintingSheet()" [class.animate-spin]="isPrintingSheet()"></i>
            <span class="text-sm">{{ isPrintingSheet() ? 'G√©n√©ration‚Ä¶' : 'Imprimer la fiche' }}</span>
          </button>
        </div>
        <!-- üìã INFORMATIONS G√âN√âRALES -->
        <div class="space-y-4">
          <div class="grid grid-cols-3 gap-4">
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                <i class="ph ph-files"></i> Contrats actifs
              </p>
              <p class="font-semibold text-slate-900 dark:text-white">{{ tenant()!.activeContracts }}</p>
            </div>
            @if (tenant()!.moveInDate) {
              <div>
                <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                  <i class="ph ph-calendar-check"></i> Date d'entr√©e
                </p>
                <p class="font-semibold text-slate-900 dark:text-white">{{ tenant()!.moveInDate | date:'dd/MM/yyyy' }}</p>
              </div>
            }
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Statut</p>
              <span class="text-xs px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 font-medium">
                {{ tenant()!.status }}
              </span>
            </div>
          </div>
          
          <!-- üë§ IDENTIT√â & NATIONALIT√â -->
          @if (tenant()!.dateOfBirth || tenant()!.nationality || tenant()!.idNumber) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-user-circle text-blue-600"></i>
                Identit√© & Nationalit√©
              </h4>
              <div class="grid grid-cols-2 gap-4">
                @if (tenant()!.dateOfBirth) {
                  <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Date de naissance</p>
                    <p class="font-medium text-slate-900 dark:text-white">{{ tenant()!.dateOfBirth | date:'dd/MM/yyyy' }}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{{ calculateAge(tenant()!.dateOfBirth!) }} ans</p>
                  </div>
                }
                @if (tenant()!.nationality) {
                  <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Nationalit√©</p>
                    <p class="font-medium text-slate-900 dark:text-white">{{ tenant()!.nationality }}</p>
                  </div>
                }
                @if (tenant()!.idNumber) {
                  <div class="col-span-2">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Num√©ro de pi√®ce d'identit√©</p>
                    <p class="font-medium text-slate-900 dark:text-white font-mono">{{ tenant()!.idNumber }}</p>
                  </div>
                }
              </div>
            </div>
          }
          
          <!-- üìç ADRESSE -->
          @if (tenant()!.address || tenant()!.city || tenant()!.postalCode || tenant()!.country) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-map-pin text-blue-600"></i>
                Adresse
              </h4>
              <div class="space-y-2">
                @if (tenant()!.address) {
                  <p class="text-sm font-medium text-slate-900 dark:text-white">{{ tenant()!.address }}</p>
                }
                <div class="flex flex-wrap gap-2 text-sm text-slate-600 dark:text-slate-400">
                  @if (tenant()!.postalCode) {
                    <span>{{ tenant()!.postalCode }}</span>
                  }
                  @if (tenant()!.city) {
                    <span>{{ tenant()!.city }}</span>
                  }
                  @if (tenant()!.country) {
                    <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded">{{ tenant()!.country }}</span>
                  }
                </div>
              </div>
            </div>
          }
          
          <!-- üíº SITUATION PROFESSIONNELLE -->
          @if (tenant()!.occupation || tenant()!.monthlyIncome) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-briefcase text-blue-600"></i>
                Situation Professionnelle
              </h4>
              <div class="grid grid-cols-2 gap-4">
                @if (tenant()!.occupation) {
                  <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Profession</p>
                    <p class="font-medium text-slate-900 dark:text-white">{{ tenant()!.occupation }}</p>
                  </div>
                }
                @if (tenant()!.monthlyIncome) {
                  <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Revenus mensuels</p>
                    <p class="text-lg font-semibold text-emerald-600 dark:text-emerald-400">
                      {{ formatCurrency(tenant()!.monthlyIncome!) }}
                    </p>
                  </div>
                }
              </div>
            </div>
          }
          
          <!-- üö® CONTACT D'URGENCE -->
          @if (tenant()!.emergencyContact || tenant()!.emergencyPhone) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-warning-circle text-orange-600"></i>
                Contact d'Urgence
              </h4>
              <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                @if (tenant()!.emergencyContact) {
                  <p class="font-semibold text-orange-900 dark:text-orange-100">{{ tenant()!.emergencyContact }}</p>
                }
                @if (tenant()!.emergencyPhone) {
                  <p class="text-sm text-orange-700 dark:text-orange-300 mt-1 flex items-center gap-1.5">
                    <i class="ph ph-phone"></i>
                    <span>{{ tenant()!.emergencyPhone }}</span>
                  </p>
                }
              </div>
            </div>
          }
          
          <!-- üõ°Ô∏è GARANT -->
          @if (tenant()!.hasGuarantor && tenant()!.guarantorName) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-shield-check text-blue-600"></i>
                Garant
              </h4>
              <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <p class="font-semibold text-blue-900 dark:text-blue-100">{{ tenant()!.guarantorName }}</p>
                @if (tenant()!.guarantorRelation) {
                  <p class="text-xs text-blue-700 dark:text-blue-300 mt-0.5">{{ tenant()!.guarantorRelation }}</p>
                }
                <div class="mt-2 space-y-1">
                  @if (tenant()!.guarantorPhone) {
                    <p class="text-sm text-slate-700 dark:text-slate-300 flex items-center gap-1.5">
                      <i class="ph ph-phone"></i>
                      <span>{{ tenant()!.guarantorPhone }}</span>
                    </p>
                  }
                  @if (tenant()!.guarantorEmail) {
                    <p class="text-sm text-slate-700 dark:text-slate-300 flex items-center gap-1.5">
                      <i class="ph ph-envelope"></i>
                      <span>{{ tenant()!.guarantorEmail }}</span>
                    </p>
                  }
                  @if (tenant()!.guarantorAddress) {
                    <p class="text-sm text-slate-700 dark:text-slate-300 flex items-center gap-1.5">
                      <i class="ph ph-map-pin"></i>
                      <span>{{ tenant()!.guarantorAddress }}</span>
                    </p>
                  }
                </div>
              </div>
            </div>
          }
          
          <!-- üìÅ DOSSIER ADMINISTRATIF -->
          @if (tenant()!.fileStatus) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <i class="ph ph-folder-open text-blue-600"></i>
                Dossier Administratif
              </h4>
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <span [class]="'text-xs px-3 py-1.5 rounded-full font-medium flex items-center gap-1.5 ' + getFileStatusBadge(tenant()!.fileStatus!).color">
                    <i [class]="'ph ' + getFileStatusBadge(tenant()!.fileStatus!).icon"></i>
                    <span>{{ getFileStatusBadge(tenant()!.fileStatus!).label }}</span>
                  </span>
                  @if (tenant()!.documentsValidated !== undefined && tenant()!.totalDocumentsRequired) {
                    <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">
                      {{ tenant()!.documentsValidated }}/{{ tenant()!.totalDocumentsRequired }} documents
                    </span>
                  }
                </div>
                @if (tenant()!.missingDocumentTypes && tenant()!.missingDocumentTypes!.length > 0) {
                  <div class="p-2 bg-orange-50 dark:bg-orange-900/20 rounded text-xs text-orange-700 dark:text-orange-400">
                    <i class="ph ph-warning"></i> Manquant: {{ tenant()!.missingDocumentTypes!.join(', ') }}
                  </div>
                }
              </div>
            </div>
          }
          
          <!-- üìù NOTES -->
          @if (tenant()!.notes) {
            <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
              <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2 flex items-center gap-2">
                <i class="ph ph-note text-blue-600"></i>
                Notes
              </h4>
              <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">{{ tenant()!.notes }}</p>
            </div>
          }
        </div>
      </div>

      <!-- Right: Statut Locatif -->
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <i class="ph ph-house-line text-blue-600"></i>
          <span>Statut Locatif</span>
        </h3>
        
        @if (currentOccupancy()) {
          <div class="space-y-4">
            <!-- Occupation actuelle -->
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Occupation actuelle</p>
              <div class="flex items-center gap-3">
                <i class="ph ph-buildings text-blue-600 text-2xl"></i>
                <div class="flex-1">
                  <p class="font-semibold text-blue-900 dark:text-blue-100">
                    {{ currentOccupancy()!.propertyName }}
                  </p>
                  @if (currentOccupancy()!.roomName) {
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                      <i class="ph ph-door text-sm"></i> {{ currentOccupancy()!.roomName }}
                    </p>
                  }
                </div>
              </div>
            </div>
            
            <!-- Dates du bail -->
            <div class="grid grid-cols-2 gap-3">
              <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Entr√©e</p>
                <p class="font-semibold text-slate-800 dark:text-white">
                  {{ currentOccupancy()!.moveInDate | date:'dd/MM/yyyy' }}
                </p>
              </div>
              <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Fin du bail</p>
                <p class="font-semibold text-slate-800 dark:text-white">
                  {{ currentOccupancy()!.leaseEndDate | date:'dd/MM/yyyy' }}
                </p>
                @if (getDaysUntilLeaseEnd(currentOccupancy()!.leaseEndDate) > 0) {
                  <p class="text-xs text-slate-500 mt-1">
                    <i class="ph ph-clock"></i> {{ getDaysUntilLeaseEnd(currentOccupancy()!.leaseEndDate) }} jours restants
                  </p>
                }
              </div>
            </div>
            
            <!-- Finances r√©sum√©es -->
            @if (financialStatus()) {
              <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 font-medium">Situation financi√®re</p>
                
                <div class="grid grid-cols-2 gap-3">
                  <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Solde du mois</p>
                    <p [class]="getPaymentStatusColor(financialStatus()!.currentMonthBalance) + ' text-xl font-bold'">
                      {{ formatCurrency(financialStatus()!.currentMonthBalance) }}
                    </p>
                  </div>
                  <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Retard total</p>
                    <p [class]="getPaymentStatusColor(financialStatus()!.totalArrears) + ' text-xl font-bold'">
                      {{ formatCurrency(financialStatus()!.totalArrears) }}
                    </p>
                  </div>
                </div>
                
                @if (financialStatus()!.lastPaymentDate) {
                  <div class="mt-3 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
                    <p class="text-xs text-emerald-700 dark:text-emerald-400 mb-1">
                      <i class="ph ph-check-circle"></i> Dernier paiement
                    </p>
                    <p class="text-sm font-semibold text-emerald-900 dark:text-emerald-100">
                      {{ formatCurrency(financialStatus()!.lastPaymentAmount) }}
                      <span class="text-xs text-emerald-600 dark:text-emerald-400 font-normal">
                        le {{ financialStatus()!.lastPaymentDate | date:'dd/MM/yyyy' }}
                      </span>
                    </p>
                  </div>
                }
              </div>
            }

            @if (depositBadge()) {
              <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg font-medium" [class]="depositBadge()!.color">
                  <i class="ph ph-warning-circle"></i>
                  <span>{{ depositBadge()!.label }}</span>
                </span>
              </div>
            }
            
            <!-- Badge statut -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
              <div class="flex items-center justify-between">
                <span class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-medium">
                  <i class="ph ph-check-circle"></i>
                  <span>Locataire en r√®gle</span>
                </span>
                
                @if (paymentStats()) {
                  <div class="text-right">
                    <p class="text-xs text-slate-500 dark:text-slate-400">R√©gularit√©</p>
                    <p class="text-lg font-bold text-emerald-600">{{ paymentStats()!.onTimeRate }}%</p>
                  </div>
                }
              </div>
            </div>
          </div>
        } @else {
          <!-- Pas d'occupation active -->
          <div class="text-center py-8">
            <i class="ph ph-house-line text-4xl text-slate-300 dark:text-slate-600 mb-2"></i>
            <p class="text-slate-500 dark:text-slate-400">Aucune occupation active</p>
            @if (contracts().length > 0) {
              <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">
                {{ contracts().length }} contrat(s) historique(s)
              </p>
            }
          </div>
        }
      </div>
    </div>

    <!-- ‚úÖ NOUVEAU: Actions globales locataire -->
    @if (associatedProperty() && tenant()) {
      <div class="flex justify-end gap-3">
        <button
          (click)="dissociateTenant()"
          [disabled]="!canDissociateTenant()"
          [class.opacity-50]="!canDissociateTenant()"
          [class.cursor-not-allowed]="!canDissociateTenant()"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition flex items-center gap-2 disabled:hover:bg-red-600"
          [title]="canDissociateTenant() ? 'Dissocier le locataire du bien' : 'Impossible: contrats actifs en cours'"
        >
          <i class="ph ph-link-break"></i>
          <span>Dissocier du bien</span>
        </button>
      </div>
    }

    <!-- Sub-tabs -->
    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl">
      <div class="flex overflow-x-auto border-b border-slate-200 dark:border-slate-700 px-4">
        @for (tab of subTabs; track tab.id) {
          <button
            (click)="activeSubTab.set(tab.id)"
            [class.border-b-2]="activeSubTab() === tab.id"
            [class.border-orange-500]="activeSubTab() === tab.id"
            [class.text-orange-600]="activeSubTab() === tab.id"
            class="px-4 py-3 text-sm font-medium whitespace-nowrap transition hover:text-orange-600"
          >
            <i [class]="'ph ' + tab.icon + ' mr-2'"></i>{{ tab.label | translate }}
          </button>
        }
      </div>

      <div class="p-6">
        @switch (activeSubTab()) {
          @case ('contracts') {
            <div>
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">{{ 'TENANT.CONTRACTS' | translate }}</h3>
                <button
                  (click)="openContractWizard()"
                  [disabled]="tenant()?.status === 'Active'"
                  [class]="tenant()?.status === 'Active'
                    ? 'px-4 py-2 bg-slate-300 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded-lg transition flex items-center gap-2 cursor-not-allowed'
                    : 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2'"
                >
                  <i class="ph ph-plus-circle"></i>
                  <span>Nouveau Contrat</span>
                </button>
              </div>
              @if (contracts().length > 0) {
                <div class="space-y-4">
                  @for (contract of contracts(); track contract.id) {
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                      <!-- Header du contrat (cliquable) -->
                      <div 
                        (click)="openPropertyTab(contract)"
                        class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition cursor-pointer"
                      >
                        <div class="flex items-center gap-4">
                          <div class="w-16 h-16 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-lg flex items-center justify-center">
                            <i class="ph ph-file-text text-2xl text-white"></i>
                          </div>
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <h4 class="font-semibold">{{ contract.type }}</h4>
                              <span class="text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-mono">{{ contract.code }}</span>
                              <!-- ‚úÖ Badge statut am√©lior√© -->
                              @if (contract.status) {
                                <span [class]="'text-xs px-2 py-1 rounded-full font-medium ' + getContractStatusBadge(contract.status).color">
                                  {{ getContractStatusBadge(contract.status).label }}
                                </span>
                              }

                              @if (getSignedAddendums(contract.id).length > 0) {
                                <span class="text-xs px-2 py-1 rounded-full font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
                                  Avenant sign√©
                                </span>
                              }

                              @if (contract.noticeEndDate) {
                                <span class="text-xs px-2 py-1 rounded-full font-medium bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300">
                                  En pr√©avis ¬∑ {{ contract.noticeEndDate | date:'dd/MM/yyyy' }}
                                </span>
                              }
                            </div>
                            <p class="text-sm text-slate-500">{{ contract.startDate | date:'dd/MM/yyyy' }} - {{ contract.endDate | date:'dd/MM/yyyy' }}</p>
                            <p class="text-sm font-medium mt-1">{{ formatCurrency(contract.rent) }}/mois</p>
                          </div>
                          
                          <div class="flex items-center gap-2">
                            <!-- Bouton pour afficher les documents (si Draft/PartialSigned/FullySigned) -->
                            @if (shouldShowDocumentsPanel(contract)) {
                              <button
                                (click)="toggleContractDocuments(contract.id, $event)"
                                class="px-3 py-1.5 text-sm rounded-lg border border-blue-300 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition"
                                [class.bg-blue-50]="isContractExpanded(contract.id)"
                                [class.dark:bg-blue-900/20]="isContractExpanded(contract.id)"
                              >
                                <i class="ph" [class.ph-caret-down]="!isContractExpanded(contract.id)" [class.ph-caret-up]="isContractExpanded(contract.id)"></i>
                                Documents
                              </button>
                            }
                          </div>
                        </div>
                      </div>

                      <!-- ‚úÖ NOUVEAU: Actions contractuelles professionnelles -->
                      <div class="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3">
                        <div class="flex flex-wrap gap-2">
                          <!-- Renouveler -->
                          @if (canRenewContract(contract)) {
                            <button
                              (click)="renewContract(contract)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-blue-300 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition flex items-center gap-1.5"
                              title="Renouveler le contrat (< 60 jours avant expiration)"
                            >
                              <i class="ph ph-arrows-clockwise"></i>
                              <span>Renouveler</span>
                            </button>
                          }
                          
                          <!-- Avenant -->
                          @if (canCreateAddendum(contract)) {
                            <button
                              (click)="createAddendum(contract)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-purple-300 text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition flex items-center gap-1.5"
                              title="Cr√©er un avenant au contrat"
                            >
                              <i class="ph ph-file-plus"></i>
                              <span>Avenant</span>
                            </button>
                          }
                          
                          <!-- Pr√©avis -->
                          @if (canGiveNotice(contract)) {
                            <button
                              (click)="giveNotice(contract)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-orange-300 text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition flex items-center gap-1.5"
                              title="Donner pr√©avis / Rompre le contrat"
                            >
                              <i class="ph ph-warning-circle"></i>
                              <span>Pr√©avis</span>
                            </button>
                          }
                          
                          <!-- EDL Entr√©e -->
                          @if (canCreateEntryInventory(contract)) {
                            <button
                              (click)="createEntryInventory(contract)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-emerald-300 text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition flex items-center gap-1.5"
                              title="Cr√©er √©tat des lieux d'entr√©e"
                            >
                              <i class="ph ph-clipboard-text"></i>
                              <span>EDL Entr√©e</span>
                            </button>
                          }
                          
                          <!-- Voir -->
                          <button
                            (click)="viewContractDocument(contract, $event)"
                            class="px-3 py-1.5 text-sm rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex items-center gap-1.5"
                            title="Voir le contrat"
                          >
                            <i class="ph ph-eye"></i>
                            <span>Voir</span>
                          </button>

                          <!-- EDL Sortie -->
                          @if (canCreateExitInventory(contract)) {
                            <button
                              (click)="createExitInventory(contract)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-red-300 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition flex items-center gap-1.5"
                              title="Cr√©er √©tat des lieux de sortie"
                            >
                              <i class="ph ph-clipboard-text"></i>
                              <span>EDL Sortie</span>
                            </button>
                          }
                          
                          <!-- T√©l√©charger PDF -->
                          <button
                            (click)="downloadContractPDF(contract)"
                            class="px-3 py-1.5 text-sm rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex items-center gap-1.5"
                            title="T√©l√©charger le PDF du contrat"
                          >
                            <i class="ph ph-download"></i>
                            <span>PDF</span>
                          </button>

                          @if (getSignedAddendums(contract.id).length > 0) {
                            <button
                              (click)="downloadAddendumPdf(getSignedAddendums(contract.id)[0], $event)"
                              class="px-3 py-1.5 text-sm rounded-lg border border-purple-300 text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition flex items-center gap-1.5"
                              title="T√©l√©charger le PDF de l'avenant sign√©"
                            >
                              <i class="ph ph-file-pdf"></i>
                              <span>PDF Avenant</span>
                            </button>
                          }
                          
                          <!-- Historique -->
                          <button
                            (click)="showContractHistory(contract)"
                            class="px-3 py-1.5 text-sm rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex items-center gap-1.5"
                            title="Afficher l'historique du contrat"
                          >
                            <i class="ph ph-clock-clockwise"></i>
                            <span>Historique</span>
                          </button>
                        </div>
                      </div>

                      <!-- Panneau documents (expandable) -->
                      @if (shouldShowDocumentsPanel(contract) && isContractExpanded(contract.id)) {
                        <div class="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                          <app-contract-documents-status [contractId]="contract.id" />
                        </div>
                      }
                    </div>
                  }
                </div>
              } @else {
                <p class="text-slate-500">{{ 'TENANT.NO_CONTRACTS' | translate }}</p>
              }
            </div>
          }
          @case ('payments') {
            <!-- üí∞ NOUVEAU TAB PAIEMENTS -->
            <tenant-payments-tab
              [tenantId]="tenant()!.id"
              [tenantName]="tenant()!.fullName"
            />
          }
          @case ('payment-history') {
            <div>
              <!-- ‚úÖ NOUVEAU: R√©sum√© financier -->
              @if (paymentStats()) {
                <div class="grid grid-cols-4 gap-4 mb-6">
                  <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1 font-medium">Solde total</p>
                    <p class="text-2xl font-bold text-blue-600">
                      {{ formatCurrency(paymentStats()!.totalPaid || 0) }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      {{ paymentStats()!.totalPayments }} paiement(s)
                    </p>
                  </div>
                  
                  @if (financialStatus()) {
                    <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                      <p class="text-xs text-slate-500 dark:text-slate-400 mb-1 font-medium">Montant d√ª ce mois</p>
                      <p class="text-2xl font-bold text-orange-600">
                        {{ formatCurrency(financialStatus()!.nextDueAmount || 0) }}
                      </p>
                      @if (financialStatus()!.nextDueDate) {
                        <p class="text-xs text-orange-600 dark:text-orange-400 mt-1">
                          <i class="ph ph-calendar"></i> √âch√©ance: {{ financialStatus()!.nextDueDate | date:'dd/MM' }}
                        </p>
                      }
                    </div>
                    
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                      <p class="text-xs text-slate-500 dark:text-slate-400 mb-1 font-medium">Retard total</p>
                      <p class="text-2xl font-bold text-red-600">
                        {{ formatCurrency(financialStatus()!.totalArrears || 0) }}
                      </p>
                      @if (financialStatus()!.totalArrears > 0) {
                        <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                          <i class="ph ph-warning"></i> Action requise
                        </p>
                      } @else {
                        <p class="text-xs text-emerald-600 dark:text-emerald-400 mt-1">
                          <i class="ph ph-check"></i> √Ä jour
                        </p>
                      }
                    </div>
                  }
                  
                  <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1 font-medium">R√©gularit√©</p>
                    <p class="text-2xl font-bold text-emerald-600">
                      {{ paymentStats()!.onTimeRate || 0 }}%
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      {{ paymentStats()!.latePayments || 0 }} retard(s)
                    </p>
                  </div>
                </div>
              }
              
              <!-- ‚úÖ NOUVEAU: Prochaines √©ch√©ances -->
              @if (financialStatus()) {
                <div class="mb-6 p-4 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800">
                  <h4 class="font-semibold mb-3 flex items-center gap-2">
                    <i class="ph ph-calendar-check text-blue-600"></i>
                    <span>Prochaines √©ch√©ances</span>
                  </h4>
                  <div class="space-y-2">
                    @if (financialStatus()!.nextDueDate) {
                      <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="ph ph-calendar text-blue-600"></i>
                          </div>
                          <div>
                            <p class="font-medium text-slate-800 dark:text-white">
                              {{ financialStatus()!.nextDueDate | date:'MMMM yyyy' }}
                            </p>
                            <p class="text-xs text-slate-500">
                              √âch√©ance: {{ financialStatus()!.nextDueDate | date:'dd/MM/yyyy' }}
                            </p>
                          </div>
                        </div>
                        <div class="text-right">
                          <p class="font-bold text-lg text-slate-800 dark:text-white">
                            {{ formatCurrency(financialStatus()!.nextDueAmount) }}
                          </p>
                          <span class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 dark:bg-orange-900/30">
                            √Ä venir
                          </span>
                        </div>
                      </div>
                    } @else {
                      <p class="text-sm text-slate-500 text-center py-4">
                        Aucune √©ch√©ance programm√©e
                      </p>
                    }
                  </div>
                </div>
              }
              
              <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="ph ph-clock-clockwise text-slate-600"></i>
                <span>{{ 'TENANT.PAYMENT_HISTORY' | translate }}</span>
              </h3>

              <div class="mb-6">
                <h4 class="font-semibold mb-3 flex items-center gap-2">
                  <i class="ph ph-receipt text-slate-600"></i>
                  <span>√âch√©ances</span>
                </h4>

                @if (isLoadingInvoices()) {
                  <div class="flex items-center justify-center p-6">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                  </div>
                } @else if (rentInvoices().length === 0) {
                  <div class="text-sm text-slate-500 text-center py-4">
                    Aucune √©ch√©ance trouv√©e
                  </div>
                } @else {
                  <div class="space-y-2">
                    @for (invoice of rentInvoices(); track invoice.id) {
                      <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="ph ph-file-pdf text-blue-600"></i>
                          </div>
                          <div>
                            <p class="font-medium text-slate-800 dark:text-white">
                              {{ invoice.month }}/{{ invoice.year }}
                            </p>
                            <p class="text-xs text-slate-500">
                              √âch√©ance: {{ invoice.dueDate | date:'dd/MM/yyyy' }}
                            </p>
                            @if (invoice.propertyName) {
                              <p class="text-xs text-slate-400">
                                <i class="ph ph-house-line text-xs"></i> {{ invoice.propertyName }}
                              </p>
                            }
                          </div>
                        </div>

                        <div class="flex items-center gap-3">
                          <div class="text-right">
                            <p class="font-semibold text-lg text-slate-800 dark:text-white">{{ formatCurrency(invoice.amount) }}</p>
                            <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 dark:bg-slate-900/30 dark:text-slate-300">
                              {{ invoice.status }}
                            </span>
                          </div>
                          <button
                            (click)="downloadInvoicePdf(invoice)"
                            class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            [disabled]="downloadingInvoiceId() === invoice.id"
                            title="T√©l√©charger la facture PDF">
                            @if (downloadingInvoiceId() === invoice.id) {
                              <i class="ph ph-spinner-gap animate-spin"></i>
                            } @else {
                              <i class="ph ph-download"></i>
                            }
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
              
              @if (payments().length > 0) {
                <div class="space-y-2">
                  @for (payment of payments(); track payment.id) {
                    <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                          <i class="ph ph-currency-eur text-emerald-600"></i>
                        </div>
                        <div>
                          <p class="font-medium text-slate-800 dark:text-white">{{ payment.paymentDate | date:'MMMM yyyy' }}</p>
                          <p class="text-xs text-slate-500">{{ payment.method }}</p>
                          @if (payment.propertyName) {
                            <p class="text-xs text-slate-400">
                              <i class="ph ph-house-line text-xs"></i> {{ payment.propertyName }}
                            </p>
                          }
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="font-semibold text-lg text-slate-800 dark:text-white">{{ formatCurrency(payment.amount) }}</p>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30">
                          {{ payment.status }}
                        </span>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center py-12">
                  <i class="ph ph-currency-eur text-4xl text-slate-300 dark:text-slate-600 mb-2"></i>
                  <p class="text-slate-500">{{ 'TENANT.NO_PAYMENTS' | translate }}</p>
                </div>
              }
            </div>
          }
          @case ('documents') {
            <documents-manager 
              [tenantId]="tenant()!.id" 
              [tenantInfo]="getTenantInfo()!" 
            />
          }
        }
      </div>
    </div>
  } @else {
    <div class="text-center text-slate-500 py-12">
      <p>{{ 'TENANT.NOT_FOUND' | translate }}</p>
    </div>
  }

  <!-- Contract Creation Wizard -->
  @if (showContractWizard()) {
    <contract-wizard-modal
      [context]="'tenant'"
      [tenant]="tenant()"
      mode="new"
      (close)="onWizardClosed()"
      (success)="onContractCreated()"
    />
  }

  @if (showInventoryExitWizard()) {
    <app-inventory-exit-wizard [wizardData]="inventoryExitData()!" (onClose)="handleInventoryExitClose($event)"></app-inventory-exit-wizard>
  }

  @if (showAddendumWizard() && addendumWizardData()) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
      <div class="w-full max-w-6xl h-[95vh] overflow-hidden">
        <contract-addendum-wizard
          [data]="addendumWizardData()!"
          (completed)="onAddendumCompleted()"
          (cancelled)="onAddendumCancelled()"
        />
      </div>
    </div>
  }

  @if (showNoticeWizard() && noticeWizardData()) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <contract-notice-wizard
        [data]="noticeWizardData()!"
        (completed)="onNoticeCompleted()"
        (cancelled)="onNoticeCancelled()"
      />
    </div>
  }

  <contract-viewer-modal
    [visible]="showContractViewer"
    (visibleChange)="showContractViewer.set($event)"
    [contractIdInput]="viewerContractId() || ''"
  />
</div>
