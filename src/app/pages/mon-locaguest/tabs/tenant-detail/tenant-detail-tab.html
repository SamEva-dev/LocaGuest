<div class="p-6 space-y-6">
  @if (isLoading()) {
    <div class="flex items-center justify-center py-12">
      <i class="ph ph-spinner text-4xl animate-spin text-slate-400"></i>
    </div>
  } @else if (tenant()) {
    <!-- Header Two Columns -->
    <div class="grid lg:grid-cols-2 gap-6">
      <!-- Left: Tenant Info Card -->
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-400 to-rose-500 flex items-center justify-center text-white text-3xl font-bold">
            {{ getInitials(tenant()!.fullName) }}
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1 flex-wrap">
              <h3 class="text-xl font-bold">{{ tenant()!.fullName }}</h3>
              <span class="text-sm px-2 py-1 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 font-mono">{{ tenant()!.code }}</span>
              
              <!-- ✅ NOUVEAU: Badge association bien -->
              @if (fromProperty()) {
                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 text-sm font-medium border border-teal-200 dark:border-teal-800">
                  <i class="ph ph-link text-base"></i>
                  <span>Associé à</span>
                  <span class="font-bold">{{ fromProperty()!.code }}</span>
                </span>
              }
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400">{{ tenant()!.email }}</p>
            @if (tenant()!.phone) {
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ tenant()!.phone }}</p>
            }
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400">Contrats actifs</p>
            <p class="font-medium">{{ tenant()!.activeContracts }}</p>
          </div>
          @if (tenant()!.moveInDate) {
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Date d'entrée</p>
              <p class="font-medium">{{ tenant()!.moveInDate | date:'dd MMM yyyy' }}</p>
            </div>
          }
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400">Statut</p>
            <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30">
              {{ tenant()!.status }}
            </span>
          </div>
        </div>
      </div>

      <!-- Right: Stats Card -->
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">{{ 'TENANT.PAYMENT_STATS' | translate }}</h3>
        @if (paymentStats()) {
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Total payé</p>
              <p class="text-2xl font-bold text-emerald-600">€ {{ paymentStats()!.totalPaid.toLocaleString() }}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Paiements</p>
              <p class="text-2xl font-bold">{{ paymentStats()!.totalPayments }}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Retards</p>
              <p class="text-lg font-semibold">{{ paymentStats()!.latePayments }}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Régularité</p>
              <p class="text-lg font-semibold text-emerald-600">{{ paymentStats()!.onTimeRate }}%</p>
            </div>
          </div>
        }
        <occupancy-chart />
      </div>
    </div>

    <!-- Sub-tabs -->
    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl">
      <div class="flex overflow-x-auto border-b border-slate-200 dark:border-slate-700 px-4">
        @for (tab of subTabs; track tab.id) {
          <button
            (click)="activeSubTab.set(tab.id)"
            [class.border-b-2]="activeSubTab() === tab.id"
            [class.border-orange-500]="activeSubTab() === tab.id"
            [class.text-orange-600]="activeSubTab() === tab.id"
            class="px-4 py-3 text-sm font-medium whitespace-nowrap transition hover:text-orange-600"
          >
            <i [class]="'ph ' + tab.icon + ' mr-2'"></i>{{ tab.label | translate }}
          </button>
        }
      </div>

      <div class="p-6">
        @switch (activeSubTab()) {
          @case ('contracts') {
            <div>
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">{{ 'TENANT.CONTRACTS' | translate }}</h3>
                <button
                  (click)="openContractWizard()"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2"
                >
                  <i class="ph ph-plus-circle"></i>
                  <span>Nouveau Contrat</span>
                </button>
              </div>
              @if (contracts().length > 0) {
                <div class="space-y-4">
                  @for (contract of contracts(); track contract.id) {
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                      <!-- Header du contrat (cliquable) -->
                      <div 
                        (click)="openPropertyTab(contract)"
                        class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition cursor-pointer"
                      >
                        <div class="flex items-center gap-4">
                          <div class="w-16 h-16 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-lg flex items-center justify-center">
                            <i class="ph ph-file-text text-2xl text-white"></i>
                          </div>
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <h4 class="font-semibold">{{ contract.type }}</h4>
                              <span class="text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-mono">{{ contract.code }}</span>
                            </div>
                            <p class="text-sm text-slate-500">{{ contract.startDate | date:'dd/MM/yyyy' }} - {{ contract.endDate | date:'dd/MM/yyyy' }}</p>
                            <p class="text-sm font-medium mt-1">€ {{ contract.rent }}/mois</p>
                          </div>
                          
                          <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">
                              {{ contract.status }}
                            </span>
                            
                            <!-- Bouton pour afficher les documents (si Draft/PartialSigned/FullySigned) -->
                            @if (shouldShowDocumentsPanel(contract)) {
                              <button
                                (click)="toggleContractDocuments(contract.id, $event)"
                                class="px-3 py-1.5 text-sm rounded-lg border border-blue-300 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition"
                                [class.bg-blue-50]="isContractExpanded(contract.id)"
                                [class.dark:bg-blue-900/20]="isContractExpanded(contract.id)"
                              >
                                <i class="ph" [class.ph-caret-down]="!isContractExpanded(contract.id)" [class.ph-caret-up]="isContractExpanded(contract.id)"></i>
                                Documents
                              </button>
                            }
                          </div>
                        </div>
                      </div>

                      <!-- Panneau documents (expandable) -->
                      @if (shouldShowDocumentsPanel(contract) && isContractExpanded(contract.id)) {
                        <div class="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                          <app-contract-documents-status [contractId]="contract.id" />
                        </div>
                      }
                    </div>
                  }
                </div>
              } @else {
                <p class="text-slate-500">{{ 'TENANT.NO_CONTRACTS' | translate }}</p>
              }
            </div>
          }
          @case ('payment-history') {
            <div>
              <h3 class="text-lg font-semibold mb-4">{{ 'TENANT.PAYMENT_HISTORY' | translate }}</h3>
              @if (payments().length > 0) {
                <div class="space-y-2">
                  @for (payment of payments(); track payment.id) {
                    <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-700 rounded-lg">
                      <div>
                        <p class="font-medium">{{ payment.paymentDate | date:'MMM yyyy' }}</p>
                        <p class="text-xs text-slate-500">{{ payment.method }}</p>
                        @if (payment.propertyName) {
                          <p class="text-xs text-slate-400">{{ payment.propertyName }}</p>
                        }
                      </div>
                      <div class="text-right">
                        <p class="font-semibold">€ {{ payment.amount }}</p>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30">
                          {{ payment.status }}
                        </span>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="text-slate-500">{{ 'TENANT.NO_PAYMENTS' | translate }}</p>
              }
            </div>
          }
          @case ('documents') {
            <documents-manager 
              [tenantId]="tenant()!.id" 
              [tenantInfo]="getTenantInfo()!" 
            />
          }
        }
      </div>
    </div>
  } @else {
    <div class="text-center text-slate-500 py-12">
      <p>{{ 'TENANT.NOT_FOUND' | translate }}</p>
    </div>
  }

  <!-- Contract Creation Wizard -->
  @if (showContractWizard()) {
    <app-contract-wizard
      (closed)="onWizardClosed()"
      (contractCreated)="onContractCreated($event)"
    />
  }
</div>
