name: LocaGuest Front - Build & Deploy

on:
  push:
    branches: ["main", "preprod", "staging"]

concurrency:
  group: locaguest-front-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute tag + build configuration
        id: meta
        shell: bash
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "deploy_env=prod" >> "$GITHUB_OUTPUT"
            echo "build_configuration=production" >> "$GITHUB_OUTPUT"
            echo "image_tag=sha-${GITHUB_SHA}-prod" >> "$GITHUB_OUTPUT"
          fi
          if [ "${GITHUB_REF_NAME}" = "preprod" ]; then
            echo "deploy_env=preprod" >> "$GITHUB_OUTPUT"
            echo "build_configuration=preprod" >> "$GITHUB_OUTPUT"
            echo "image_tag=sha-${GITHUB_SHA}-preprod" >> "$GITHUB_OUTPUT"
          fi
          if [ "${GITHUB_REF_NAME}" = "staging" ]; then
            echo "deploy_env=staging" >> "$GITHUB_OUTPUT"
            echo "build_configuration=staging" >> "$GITHUB_OUTPUT"
            echo "image_tag=sha-${GITHUB_SHA}-staging" >> "$GITHUB_OUTPUT"
          fi

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            BUILD_CONFIGURATION=${{ steps.meta.outputs.build_configuration }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/locaguest-front:${{ steps.meta.outputs.image_tag }}

      - name: Deploy (VPS)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            IMAGE_TAG="${{ steps.meta.outputs.image_tag }}"
            DEPLOY_ENV="${{ steps.meta.outputs.deploy_env }}"
            cd /opt/locaguest

            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"

            upsert_env () {
              local key="$1"
              local value="$2"
              if grep -qE "^${key}=" .env; then
                sed -i "s|^${key}=.*|${key}=${value}|" .env
              else
                echo "${key}=${value}" >> .env
              fi
            }

            if [ "${DEPLOY_ENV}" = "prod" ]; then
              upsert_env "LOCAGUEST_FRONT_TAG_PROD" "${IMAGE_TAG}"
              docker compose up -d caddy
              docker compose --profile prod pull locaguest-front-prod
              docker compose --profile prod up -d locaguest-front-prod
              docker compose --profile prod ps
            fi

            if [ "${DEPLOY_ENV}" = "preprod" ]; then
              upsert_env "LOCAGUEST_FRONT_TAG_PREPROD" "${IMAGE_TAG}"
              docker compose up -d caddy
              docker compose --profile preprod pull locaguest-front-preprod
              docker compose --profile preprod up -d locaguest-front-preprod
              docker compose --profile preprod ps
            fi

            if [ "${DEPLOY_ENV}" = "staging" ]; then
              upsert_env "LOCAGUEST_FRONT_TAG_STAGING" "${IMAGE_TAG}"
              docker compose up -d caddy
              docker compose --profile staging pull locaguest-front-staging
              docker compose --profile staging up -d locaguest-front-staging
              docker compose --profile staging ps
            fi
